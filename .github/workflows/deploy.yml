name: Deploy to EC2

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  APP_NAME: awale-portfolio
  DEPLOY_PATH: /var/www/ci-cd
  NODE_VERSION: "18"

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      
      - name: Install dependencies
        run: npm ci
        
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Setup directory
            sudo mkdir -p ${{ env.DEPLOY_PATH }}
            sudo chown -R ubuntu:ubuntu ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }}
            
            # Pull latest code (clone if doesn't exist, pull if it does)
            if [ -d ".git" ]; then
              echo "Repository exists, pulling latest changes..."
              git pull origin main
            else
              echo "Cloning repository for the first time..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Install dependencies (production only)
            echo "Installing dependencies..."
            npm install --omit=dev
            
            # Stop existing app (gracefully handle if not running)
            echo "Managing PM2 process..."
            pm2 stop ${{ env.APP_NAME }} 2>/dev/null || echo "App not running, starting fresh"
            pm2 delete ${{ env.APP_NAME }} 2>/dev/null || echo "No existing app to delete"
            
            # Start app
            echo "Starting application..."
            pm2 start app.js --name ${{ env.APP_NAME }}
            pm2 save
            
            # Verify app is running
            echo "Verifying deployment..."
            pm2 status
            sleep 5
            
            # Health check
            echo "Running health check..."
            if curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
            else
              echo "âš ï¸ Health check warning - endpoint not responding"
            fi
            
            echo "âœ… Deployment completed successfully!"
      
      - name: Deployment Success
        run: |
          echo "ğŸš€ Application deployed successfully to EC2"
          echo "ğŸ“¦ App Name: ${{ env.APP_NAME }}"
          echo "ğŸ“ Location: ${{ env.DEPLOY_PATH }}"
          echo "ğŸ”— URL: http://${{ secrets.EC2_HOST }}:8080"