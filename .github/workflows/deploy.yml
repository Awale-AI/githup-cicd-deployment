name: Deploy Portfolio to EC2 (Debug)

on:
  push:
    branches: [ main ]

env:
  APP_NAME: awale-portfolio
  DEPLOY_PATH: /var/www/ci-cd

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Debug Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== DEBUGGING DEPLOYMENT ==="
            
            # Check directory
            echo "1. Checking directory: ${{ env.DEPLOY_PATH }}"
            ls -la ${{ env.DEPLOY_PATH }} || echo "Directory doesn't exist"
            
            # Check Docker
            echo "2. Checking Docker installation"
            docker --version || echo "Docker not installed"
            
            # Check for Dockerfile
            echo "3. Looking for Dockerfile"
            find ${{ env.DEPLOY_PATH }} -name "Dockerfile" || echo "Dockerfile not found"
            
            # Check if port 8080 is available
            echo "4. Checking port 8080"
            sudo netstat -tlnp | grep 8080 || echo "Port 8080 is free"
            
            # Try to pull code
            echo "5. Attempting git pull"
            cd ${{ env.DEPLOY_PATH }}
            git status || echo "Not a git repository"
            
            echo "=== Debug Complete ==="